<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMO Grid World</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        #game-container {
            display: grid;
            border: 2px solid #555;
            background-color: #222;
        }
        .grid-cell {
            width: 20px;
            height: 20px;
            box-sizing: border-box;
        }
        .ground { background-color: #4a4a4a; }
        .player { background-color: #3498db; z-index: 10; border-radius: 4px; transform: scale(0.9);}
        .other-player { background-color: #e74c3c; z-index: 10; border-radius: 4px; transform: scale(0.9);}
        .rock { background-color: #888; }
        .tree { background-color: #27ae60; }
        .water { background-color: #2980b9; }
        #info-panel {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #2c3e50;
            border-radius: 8px;
            text-align: center;
        }
        .controls {
            margin-top: 10px;
            font-size: 0.9em;
            color: #bdc3c7;
        }
        #player-id {
            margin-top: 5px;
            font-size: 0.8em;
            color: #7f8c8d;
            word-break: break-all;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <h1>MMO Grid World</h1>
    <div id="game-container"></div>
    <div id="info-panel">
        <div id="player-coords">Connecting to server...</div>
        <div class="controls">Use Arrow Keys to Move</div>
        <div id="player-id"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameContainer = document.getElementById('game-container');
            const playerCoordsEl = document.getElementById('player-coords');
            const playerIdEl = document.getElementById('player-id');
            
            // --- WebSocket Setup ---
            const ws = new WebSocket(`ws://${window.location.hostname}:8080/ws`);

            // --- Game Configuration ---
            const VIEWPORT_WIDTH = 31;
            const VIEWPORT_HEIGHT = 21;
            const TILE_SIZE = 20;

            // --- Game State (Client-Side) ---
            let clientState = {
                playerId: null,
                players: {},
                world: {} 
            };
            
            // --- WebSocket Event Handlers ---
            ws.onopen = () => {
                console.log('Connected to the server.');
                playerCoordsEl.textContent = 'Connected! Waiting for world state...';
                document.addEventListener('keydown', handleKeyDown);
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);

                // The server is the source of truth, so we update the client state
                // based on broadcasted messages.
                switch(msg.type) {
                    case 'initial_state': // Server could send this on connect
                        clientState.playerId = msg.playerId;
                        clientState.players = msg.players;
                        playerIdEl.textContent = `Your ID: ${msg.playerId}`;
                        break;
                    
                    case 'player_moved':
                        clientState.players[msg.playerId] = { x: msg.x, y: msg.y };
                        break;

                    case 'player_joined': // A new player appeared
                         clientState.players[msg.playerId] = { x: msg.x, y: msg.y };
                         break;
                    
                    case 'player_left': // A player disconnected
                        delete clientState.players[msg.playerId];
                        break;
                }
                
                // Re-render the game view whenever state changes
                renderViewport();
            };

            ws.onclose = () => {
                console.log('Disconnected from the server.');
                playerCoordsEl.textContent = 'Disconnected. Please refresh.';
                document.removeEventListener('keydown', handleKeyDown);
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                playerCoordsEl.textContent = 'Connection error.';
            };
            
            // --- Procedural Generation (Client-Side for unknown tiles) ---
            // This remains on the client to render terrain the server hasn't told us about yet.
            // In a more advanced setup, the client would request chunk data from the server.
            function getTileType(x, y) {
                const key = `${x},${y}`;
                if (clientState.world[key]) {
                    return clientState.world[key];
                }
                const noise = (Math.sin(x * 12.9898 + y * 78.233) * 43758.5453) % 1;
                let type;
                if (noise > 0.95) type = 'rock';
                else if (noise > 0.90) type = 'tree';
                else if (noise > 0.88) type = 'water';
                else type = 'ground';
                clientState.world[key] = type;
                return type;
            }

            // --- Rendering Engine ---
            function renderViewport() {
                const me = clientState.players[clientState.playerId];
                if (!me) {
                    // Don't render if we don't know who we are yet
                    return;
                }

                gameContainer.innerHTML = '';
                gameContainer.style.gridTemplateColumns = `repeat(${VIEWPORT_WIDTH}, ${TILE_SIZE}px)`;
                gameContainer.style.gridTemplateRows = `repeat(${VIEWPORT_HEIGHT}, ${TILE_SIZE}px)`;

                const halfWidth = Math.floor(VIEWPORT_WIDTH / 2);
                const halfHeight = Math.floor(VIEWPORT_HEIGHT / 2);
                const startX = me.x - halfWidth;
                const startY = me.y - halfHeight;

                for (let j = 0; j < VIEWPORT_HEIGHT; j++) {
                    for (let i = 0; i < VIEWPORT_WIDTH; i++) {
                        const cell = document.createElement('div');
                        const worldX = startX + i;
                        const worldY = startY + j;

                        let playerOnTile = null;
                        for (const id in clientState.players) {
                            const p = clientState.players[id];
                            if (p.x === worldX && p.y === worldY) {
                                playerOnTile = id;
                                break;
                            }
                        }

                        let finalClass = 'grid-cell';
                         if (playerOnTile) {
                            finalClass += playerOnTile === clientState.playerId ? ' player' : ' other-player';
                        } else {
                            finalClass += ` ${getTileType(worldX, worldY)}`;
                        }
                        
                        cell.className = finalClass;
                        gameContainer.appendChild(cell);
                    }
                }

                playerCoordsEl.textContent = `Your Position: (${me.x}, ${me.y})`;
            }

            // --- Input Handling ---
            function handleKeyDown(e) {
                let direction = null;
                switch (e.key) {
                    case 'ArrowUp': direction = 'up'; break;
                    case 'ArrowDown': direction = 'down'; break;
                    case 'ArrowLeft': direction = 'left'; break;
                    case 'ArrowRight': direction = 'right'; break;
                    default: return;
                }
                
                // Send the input to the server
                const msg = {
                    type: 'move',
                    payload: { direction: direction }
                };
                ws.send(JSON.stringify(msg));
            }
        });
    </script>
</body>
</html>